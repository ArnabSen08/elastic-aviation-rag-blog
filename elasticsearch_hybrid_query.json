{
  "description": "Hybrid Search Query with BM25 + Vector Search + RRF for Aviation Manuals",
  "query": {
    "POST": "aviation_manuals/_search",
    "body": {
      "size": 10,
      "rank": {
        "rrf": {
          "window_size": 100,
          "rank_constant": 60
        }
      },
      "sub_searches": [
        {
          "query": {
            "bool": {
              "should": [
                {
                  "match": {
                    "content": {
                      "query": "How do I reset the APU after a master warning?",
                      "boost": 1.0
                    }
                  }
                },
                {
                  "match_phrase": {
                    "content": {
                      "query": "APU master warning reset",
                      "boost": 1.5
                    }
                  }
                }
              ],
              "minimum_should_match": 1
            }
          }
        },
        {
          "query": {
            "knn": {
              "field": "embedding",
              "query_vector": "<384-dimensional vector from all-MiniLM-L6-v2>",
              "k": 100,
              "num_candidates": 1000,
              "boost": 2.0
            }
          }
        },
        {
          "query": {
            "bool": {
              "should": [
                {
                  "term": {
                    "part_number": {
                      "value": "APU-MSTR-RESET",
                      "boost": 2.0
                    }
                  }
                },
                {
                  "match": {
                    "section": {
                      "query": "APU Warnings and Resets",
                      "boost": 1.2
                    }
                  }
                }
              ]
            }
          }
        }
      ],
      "_source": [
        "content",
        "page",
        "section",
        "part_number",
        "manual_id",
        "chapter"
      ],
      "highlight": {
        "fields": {
          "content": {
            "fragment_size": 180,
            "number_of_fragments": 2,
            "pre_tags": ["<mark>"],
            "post_tags": ["</mark>"]
          }
        }
      }
    }
  },
  "explanation": {
    "rrf": "Reciprocal Rank Fusion combines rankings from BM25, vector search, and metadata filters",
    "window_size": "Top 100 results from each sub-search are considered for fusion",
    "rank_constant": "Controls the weight distribution (60 is balanced)",
    "boost_values": {
      "match_phrase": 1.5,
      "knn": 2.0,
      "part_number": 2.0,
      "section": 1.2
    },
    "embedding_model": "sentence-transformers/all-MiniLM-L6-v2 (384 dimensions)"
  }
}
